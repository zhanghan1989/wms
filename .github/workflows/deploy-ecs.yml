name: Deploy ECS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_migrations:
        description: "Manual deploy: run prisma migrate deploy"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect migration changes
        id: migration_check
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          BEFORE_SHA: ${{ github.event.before }}
          AFTER_SHA: ${{ github.sha }}
          RUN_MIGRATIONS_INPUT: ${{ github.event.inputs.run_migrations }}
        run: |
          set -euo pipefail

          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            if [ "${RUN_MIGRATIONS_INPUT:-true}" = "true" ]; then
              echo "should_run=true" >> "${GITHUB_OUTPUT}"
            else
              echo "should_run=false" >> "${GITHUB_OUTPUT}"
            fi
            exit 0
          fi

          if [ -z "${BEFORE_SHA}" ] || [ "${BEFORE_SHA}" = "0000000000000000000000000000000000000000" ]; then
            echo "should_run=true" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          if git diff --name-only "${BEFORE_SHA}" "${AFTER_SHA}" | grep -q '^apps/api/prisma/migrations/'; then
            echo "should_run=true" >> "${GITHUB_OUTPUT}"
          else
            echo "should_run=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Deploy to ECS by SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ECS_HOST }}
          port: ${{ secrets.ECS_PORT }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            cd ~/wms
            git fetch --all --prune
            git checkout main
            git reset --hard origin/main
            docker compose up -d db redis
            if [ "${{ steps.migration_check.outputs.should_run }}" = "true" ]; then
              echo "Migration changes detected. Running prisma migrate deploy..."
              docker compose run --rm --build api npm run -w api prisma:migrate:deploy
            else
              echo "No migration changes detected. Skip prisma migrate deploy."
            fi
            docker compose up -d api
            docker compose ps
